<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
	</head>
	<style>
		#add-picture {
			display: block;
			float: left;
			width: 100px;
			height: 100px;
			border: 7px solid #259B2A;
			border-radius: 10px;
			line-height: 57px;
			text-align: center;
			font-size: 100px;
			font-weight: bold;
			color: #259B2A;
		}
		
		#pictures img {
			height: 100px;
			width: auto;
			float: left;
			margin-right: 20px;
			margin-bottom: 10px;
		}
		
		#imgcount {
			color: #259B2A;
		}
	</style>

	<body>
		<div class="mui-content-padded" style="margin: 5px 10px;">
			<div class="mui-input-row" style="margin: 10px 0;">
				<textarea id="textarea" rows="5" placeholder="请输入描述内容"></textarea>
				<h5>您还可以添加<span id="imgcount">10</span>张图片</h5>
			</div>
			<div id="pictures"></div>
			<div id="add-picture">+</div>
		</div>

		<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#" data="1">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="#" data="2">从相册中选择</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture" data="0"><b>取消</b></a>
				</li>
			</ul>
		</div>
		<script type="text/javascript" src="../js/common.js"></script>
		<script src="../js/mui.js"></script>
		<script type="text/javascript">
			mui.init();
			var MAXIMAGECOUNT = 10;
			var nImageCount = 0;
			mui.plusReady(function() {
				window.addEventListener('delete', function(event) {
					var deleteid = event.detail - 1;
					document.getElementById("pictures").removeChild(document.getElementById("pictures").getElementsByTagName("img")[deleteid].parentNode);
					nImageCount--;
					fIsAddButtomExist();
				});

			});

			mui(".mui-content-padded").on("tap", "#add-picture", function() {
				document.activeElement.blur();
				mui("#picture").popover('toggle');
			});
			mui('#picture').on('tap', '.mui-popover-action li>a', function() {
				switch(this.getAttribute("data")) {
					case "1": //拍照
						mui("#picture").popover('toggle');
						getImage();
						break;
					case "2": //从相册选择
						mui("#picture").popover('toggle');
						galleryImg();
						break;
					default:
						break;
				}
			});
			mui("#pictures").on("tap", "img", function() {
				var arrObjects = this.parentNode.parentNode.innerHTML;
				indexId = index(this, this.parentNode.parentNode.getElementsByTagName("img"));
				mui.openWindow({
					url: "../module/preview_image.html",
					id: "preview_image",
					styles: {
						top: 0,
						bottom: 0,
						right: 0,
						width: "100%",
						height: "100%"
					},
					extras: {
						images: arrObjects,
						indexid: indexId,
						deletemode: "true"
					},
					show: {
						aniShow: "fade-in"
					},
					waiting: {
						autoShow: false,
					}
				});
			})

			function getImage() {
				var cmr = plus.camera.getCamera();
				cmr.captureImage(function(p) {
					console.log("成功：" + p);
					plus.io.resolveLocalFileSystemURL(p, function(entry) {
						console.log(entry.fullPath); //真实路径
						plus.gallery.save(p, function() {
							console.log("保存图片到相册成功");
						});
						var localurl = entry.toLocalURL();
						var pictureContaint = document.getElementById("pictures");
						var newpic = document.createElement("div");
						newpic.className = "picture";
						newpic.innerHTML = "<img src=" + localurl + " data-preview-src='' data-preview-group='1' />";
						pictureContaint.appendChild(newpic);
						nImageCount++;
						fIsAddButtomExist();
					}, function(e) {
						console.log("读取拍照文件错误：" + e.message);
					});
				}, function(e) {
					console.log("失败：" + e.message);
				}, {
					filename: "_doc/camera/"
				});
			}

			function galleryImg() {
				// 从相册中选择图片
				plus.gallery.pick(function(path) {
					for(var i in path.files) {
						var pictureContaint = document.getElementById("pictures");
						var newpic = document.createElement("div");
						newpic.className = "picture";
						newpic.innerHTML = "<img src=" + path.files[i] + " data-preview-src='' data-preview-group='1' />";
						pictureContaint.appendChild(newpic);
						nImageCount++;
						fIsAddButtomExist();
					}

				}, function(e) {
					console.log("取消选择图片");
				}, {
					filter: "image",
					multiple: true,
					maximum: MAXIMAGECOUNT - nImageCount
				});
			}

			function fIsAddButtomExist() {
				document.getElementById("imgcount").innerText = MAXIMAGECOUNT - nImageCount;
				nImageCount >= MAXIMAGECOUNT ? document.getElementById("add-picture").style.display = "none" : document.getElementById("add-picture").style.display = "block";
			}
		</script>
	</body>

</html>