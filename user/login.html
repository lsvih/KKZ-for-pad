<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/common.css" />
	</head>
	<style>
		.login {
			text-align: center;
			font-size: 30px;
			font-weight: bold;
			margin-top: 50px;
		}

		
		.mui-progressbar span {
			background: #4cd964!important;
			z-index: 111!important;
		}
	</style>

	<body>
		<div class="login">看什么看，赶紧登录啊！(ﾉ･ω･)ﾉﾞ</div>
		<div class="mui-content-padded" style="margin: 55px 250px;">

			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>输用户名啊魂淡</label>
					<input id="username" type="text" class="mui-input-clear" placeholder="在这输啊？！">
				</div>
				<div class="mui-input-row mui-password">
					<label>输密码啊魂淡</label>
					<input id="password" type="password" class="mui-input-password" placeholder="忘记密码了？不给你找回╭(╯^╰)╮">
				</div>
				<div class="mui-button-row">
					<button type="button" class="mui-btn mui-btn-primary" id="login">登录</button>&nbsp;&nbsp;
					<button type="button" class="mui-btn mui-btn-danger" disabled>取消不给你点，打我啊？</button>
				</div>
			</form>
		</div>
		<script src="../js/mui.js"></script>
		<script type="text/javascript" src="../js/storage.js" ></script> 
		<script type="text/javascript" src="../js/common.js"></script>
		<script type="text/javascript">
			mui.init()
			var successfilecount = 0;
			var loading;
			var datalength;
			var insertSuccessCount;
			mui.plusReady(function() {
				if(!localStorage.getItem("firstrun")) {
					mui.alert("即将下载资源包，请确认当前网络环境为WiFi。", gAppName, "确认", function() {
						if(plus.networkinfo.getCurrentType() != 3) { //判断当前环境是否为wifi环境
							mui.alert("请确认您的网络环境为WiFi环境", gAppName, "确认", function() {
								plus.runtime.restart();
							});
						} else { //如果为wifi环境则开始下载资源包
							loading = plus.nativeUI.showWaiting("正在下载资源包列表，请耐心等待...");
							mui.ajax(gServer + 'house-packages', {//下载套餐包数据
								dataType: 'json',
								type: 'get',
								timeout: 6000,
								success: function(data) {
									
									

								},
								error: function(xhr, textStatus, errorThrown) { //如果获取资源包列表时的网络连接失败了，则判定当前网络状态差，重新执行
									mui.alert("请确认网络连接后重试", gAppName, "确认", function() {
										plus.runtime.restart();
									});
								}
							});
							
							
							mui('body').progressbar({
								progress: 0,
								color: 'success'
							}).show();
							//显示进度条与遮罩,提示开始下载
							mui.ajax(gServer + 'uploads/assets/commonFiles.txt', {
								dataType: 'text',
								type: 'get',
								timeout: 6000,
								success: function(data) {
									loading.setTitle("正在下载资源包，请耐心等待...")
									var arr = eval(data); //将资源包列表转换为数组对象进行遍历
									for(var i = 0; i < arr.length; i++) {
										var filenamearr = arr[i].split("/");
										var filename = filenamearr[filenamearr.length - 1];
										if(!myStorage.getItem("filename")) {
											DownloadResource(gServer + 'uploads/' + arr[i]);
										}
									}
									var processController = setInterval(function() {
										if(successfilecount < arr.length) {
											mui("body").progressbar().setProgress(successfilecount / arr.length);
										}
										if(successfilecount == arr.length) {
											clearInterval(processController);
											mui("body").progressbar().setProgress(100);
											localStorage.setItem("firstrun", fGetDate());
											mui.toast("资源包下载完成！");
										}
									}, 50); //定时检查是否完成下载，同时更新进度条

								},
								error: function(xhr, textStatus, errorThrown) { //如果获取资源包列表时的网络连接失败了，则判定当前网络状态差，重新执行
									mui.alert("请确认网络连接后重试", gAppName, "确认", function() {
										plus.runtime.restart();
									});
								}
							});
						}

					});
				}
				mui("body").on("tap", "#login", function() {
					var username = document.getElementById("username").value;
					var password = document.getElementById("password").value;
					if(!username) {
						mui.alert("滚回去输用户名", gAppName);
						return false;
					}
					if(!password) {
						mui.alert("滚回去输密码", gAppName);
						return false;
					}
					loading = plus.nativeUI.showWaiting("正在登录，请稍后...");
					mui.ajax(gAPIServer + 'users/login', {
						data: {
							'LoginForm[username]': username,
							'LoginForm[password]': password
						},
						dataType: 'json',
						type: 'post',
						timeout: 6000,
						success: function(data) {
							if(data.success == true) {
								localStorage.user = JSON.stringify({
									"id": data.data.id,
									"username": data.data.username,
									"sex": data.data.sex,
									"head_img-url": data.data["head_img-url"],
									"access_token": data.data.access_token
								});
								loading.setTitle("正在加载用户数据，请稍后");
								mui.ajax(gAPIServer + 'users/' + User("id") + '?expand=houses0.user,houses0.housePackages.package&access-token=' + User("access_token"), {
									dataType: 'json',
									type: 'get',
									timeout: 6000,
									success: function(data) {
										if(data.success == true) {
//											console.log(JSON.stringify(data));
											if(!data.data.houses0) {
												myStorage.setItem("data", JSON.stringify({
														"event": []
													})) //如果房屋信息不存在，则直接让event为空数组
											} else { //如果信息存在，则将后台数据格式转化为前端数据格式存入myStorage.data中
												var ToInsertData = data.data.houses0;
												datalength = ToInsertData.length;
												insertSuccessCount = 0; //成功计数
												var Tempdata = {
													"event": []
												};
												console.log(JSON.stringify(ToInsertData)) 
												for(var i = 0; i < ToInsertData.length; i++) {
													Tempdata.event[i] = {
														"id": ToInsertData[i].id,
														"name": ToInsertData[i].user.fullname,
														"sex": Number(ToInsertData[i].user.sex),
														"contractid": ToInsertData[i].house_contract.split(".")[0],
														"status": ToInsertData[i].status,
														"province": ToInsertData[i].province,
														"city": ToInsertData[i].city,
														"district": ToInsertData[i].county,
														"street": ToInsertData[i].street,
														"address": ToInsertData[i].address,
														"phone": ToInsertData[i].user.phone,
														"content": {
															"ordertime": fTimeStampToDate(ToInsertData[i].appointment_at),
															"package": __fMapPackage(ToInsertData[i].housePackages),
															"price": ToInsertData[i].package_amount,
															"clear_amount": ToInsertData[i].clear_amount,
															"distance_rate":ToInsertData[i].distance_rate,
															"taxes_amount":ToInsertData[i].taxes_amount
														}
													}
													insertSuccessCount++; //成功计数增加
												}
											}
											/**
											 * 子函数
											 * 解析package数组信息，返回符合格式的package数组
											 * @param {Array} 待解析package数组
											 */
											function __fMapPackage(packagearr) {
												if(!packagearr || !packagearr.legnth) return [];
												var __temparr = [];
												for(var __i = 0; __i < packagearr; __i++) {
													__temparr.push({
														"id": packagearr[__i].id,
														"name": packagearr[__i].package.name,
														"size": packagearr[__i].area,
														"images": packagearr[__i].measure_t_imgs,
														"diagram": packagearr[__i].plan_t_img
													})
												}
												return __temparr;
											}

											var LoadingUserinfo = setInterval(function() {
												if(insertSuccessCount == datalength) {
													clearInterval(LoadingUserinfo);
													myStorage.setItem("data",JSON.stringify(Tempdata));
													loading.close();
													mui.alert("登陆成功，" + gAppName + "即将重新启动以加载数据！", gAppName, "确认", function() {
														plus.runtime.restart();
													});
												}
											}, 50); //定时检查是否完成下载，同时更新进度条

										} else {
											mui.alert(data.message, gAppName);
											console.log(JSON.stringify(data));
										}
									},
									error: function(xhr, textStatus, errorThrown) {
										mui.alert("获取用户信息时网络连接失败，请稍候再试", gAppName);
										loading.close();
									}
								});
							} else {
								mui.alert(data.message, gAppName);
								loading.close();
								console.log(JSON.stringify(data));
							}
						},
						error: function(xhr, textStatus, errorThrown) {
							mui.alert("登录时网络连接失败，请稍后重试", gAppName);
							loading.close();
						}
					});

				});
			});

			function DownloadResource(url) {
				var urlarr = url.split("/");
				var downloadfilename = urlarr[urlarr.length - 1]; //读出文件名
				console.log("Downloading '" + url + "' to cache...");
				var dtask = plus.downloader.createDownload(url, {}, function(d, status) {
					switch(status) {
						case 404:
							//如果文件不存在，也当其下载成功数+1
							console.log("下载失败,文件不存在");
							successfilecount++;
							break;
						case 200:
							successfilecount++;
							downloadfilename = d.filename.split("/")[1]; //d.filename读出来为_downloads/xxxxxx.xxx形式
							console.log("下载成功=" + downloadfilename);
							myStorage.setItem(downloadfilename, true); //删除路径前的"_downloads/"以提高存储密度
							break;
						default:
							console.log("下载失败=" + status);
							mui.alert("网络异常，下载任务已暂停，请检查网络环境后重试。", gAppName, "确定", function() {
								plus.runtime.restart();
							})
					}
				});
				//启动下载任务
				dtask.start();

			}
		</script>
	</body>

</html>